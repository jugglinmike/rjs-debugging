# r.js issue

## Background

I'm trying to optimize multiple files according to [the `example-multipage`
example](https://github.com/requirejs/example-multipage). Here's a simplified
version of my project's directory structure:

    $ tree src/
    src/
    ├── activities
    │   └── first
    │       ├── main.js
    │       ├── module.js
    │       └── template.jade
    └── client
        ├── amd-config.js
        ├── index.html
        ├── main.js
        └── require.js


I am trying to build a separate module for each subdirectory within the
`activities/` directory.

For succinctness, each of these modules will load their dependencies using
relative module IDs. In `src/activities/first/main.js`, I might write:

```javascript
define(function(require) {
  require('./module');
  require('text!./template.jade');
});
```

## Problem

The above example works for JavaScript modules (`require('./module')`), but the
paths resolve incorrectly when loading via a plugin
(`require('text!./template.jade')`). In my application, this is currently
working in the runtime but failing during the build phase. In this small demo
app, both environments resolve paths incorrectly.

Browser error:

    GET http://localhost:8080/src/activities/activities/activities/first/template.jade 404 (File not found) text.js:303
    XHR finished loading: "http://localhost:8080/src/activities/activities/activities/first/template.jade". text.js:303
    Uncaught Error: /src/client/../activities/activities/activities/first/template.jade HTTP status: 404
    http://requirejs.org/docs/errors.html#timeout

r.js error:

    > rjs-test@0.0.0 build /home/mike/tmp/rjs
    > r.js -o config-optimizer.js

    Error: ENOENT, no such file or directory '/home/mike/tmp/rjs/out/client/../activities/activities/activities/first/template.jade'
    In module tree:
        main
          ../activities/first/main
            text

    Error: Error: ENOENT, no such file or directory '/home/mike/tmp/rjs/out/client/../activities/activities/activities/first/template.jade'
    In module tree:
        main
          ../activities/first/main
            text

        at Object.fs.openSync (fs.js:427:18)

## Reproducing

1. Clone this repository.
2. Run a static webserver from the root of this repo. Visit the
   `src/client/index.html` file in a web browser. Note the runtime error in
   the developer's console.
3. Run `$ npm run build`. Note the error generated by r.js
